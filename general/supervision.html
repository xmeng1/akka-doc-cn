<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Supervision and Monitoring &bull; Akka Documentation 中文</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="akka-docs-cn"/>
<link rel="canonical" href="http://doc.akka.io/docs/akka/current/general/supervision.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png">
<link rel="manifest" href="../images/manifest.json">
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png">
<meta name="msapplication-TileColor" content="#15a9ce">
<meta name="theme-color" content="#15a9ce">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://optanon.blob.core.windows.net/consent/159bb13d-6748-4399-806e-ac28db879785.js" type="text/javascript" charset="UTF-8"></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-21117439-1']);
_gaq.push(['_setDomainName', 'akka.io']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<script type="text/plain" class="optanon-category-2">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-23127719-1', 'lightbend.com', {'allowLinker': true, 'name': 'tsTracker'});
ga('tsTracker.require', 'linker');
ga('tsTracker.linker:autoLink', ['lightbend.com','playframework.com','scala-lang.org','scaladays.org','spray.io','akka.io','scala-sbt.org','scala-ide.org']);
ga('tsTracker.send', 'pageview');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="http://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Documentation 中文</a></h1>
</div>
<div class="nav-header-version">
Version 2.5-SNAPSHOT
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
</div>
<div id="overlay-search-container" class="nav-header-search">
<input id="overlay-search" type="search" class="search" placeholder="Search"/>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../guide/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="../general/index.html" class="page">General Concepts</a>
  <ul>
    <li><a href="../general/terminology.html" class="page">Terminology, Concepts</a></li>
    <li><a href="../general/actor-systems.html" class="page">Actor Systems</a></li>
    <li><a href="../general/actors.html" class="page">What is an Actor?</a></li>
    <li><a href="../general/supervision.html#supervision-and-monitoring" class="active page">Supervision and Monitoring</a>
    <ul>
      <li><a href="../general/supervision.html#sample-project" class="header">Sample project</a></li>
      <li><a href="../general/supervision.html#what-supervision-means" class="header">What Supervision Means</a></li>
      <li><a href="../general/supervision.html#the-top-level-supervisors" class="header">The Top-Level Supervisors</a></li>
      <li><a href="../general/supervision.html#what-restarting-means" class="header">What Restarting Means</a></li>
      <li><a href="../general/supervision.html#what-lifecycle-monitoring-means" class="header">What Lifecycle Monitoring Means</a></li>
      <li><a href="../general/supervision.html#one-for-one-strategy-vs-all-for-one-strategy" class="header">One-For-One Strategy vs. All-For-One Strategy</a></li>
    </ul></li>
    <li><a href="../general/addressing.html" class="page">Actor References, Paths and Addresses</a></li>
    <li><a href="../general/remoting.html" class="page">Location Transparency</a></li>
    <li><a href="../general/jmm.html" class="page">Akka and the Java Memory Model</a></li>
    <li><a href="../general/message-delivery-reliability.html" class="page">Message Delivery Reliability</a></li>
    <li><a href="../general/configuration.html" class="page">Configuration</a></li>
  </ul></li>
  <li><a href="../index-actors.html" class="page">Actors</a></li>
  <li><a href="../typed/index.html" class="page">Akka Typed</a></li>
  <li><a href="../index-cluster.html" class="page">Clustering</a></li>
  <li><a href="../stream/index.html" class="page">Streams</a></li>
  <li><a href="../index-network.html" class="page">Networking</a></li>
  <li><a href="../discovery/index.html" class="page">Discovery</a></li>
  <li><a href="../index-futures.html" class="page">Futures and Agents</a></li>
  <li><a href="../index-utilities.html" class="page">Utilities</a></li>
  <li><a href="../common/other-modules.html" class="page">Other Akka modules</a></li>
  <li><a href="../howto.html" class="page">HowTo: Common Patterns</a></li>
  <li><a href="../project/index.html" class="page">Project Information</a></li>
  <li><a href="../additional/index.html" class="page">Additional Information</a></li>
  <li><a href="../chinese/index.html" class="page">中文版文档说明</a></li>
</ul>
</nav>
</div>
</header>

<aside class="show-for-large">
<header class="nav-header fixed-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Documentation 中文</a></h1>
</div>
<div class="nav-header-version">
Version 2.5-SNAPSHOT
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
</div>
<div class="nav-header-search">
<input id="search" type="search" class="search" placeholder="Search"/>
</div>
</header>
<nav class="site-nav fixed-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../guide/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="../general/index.html" class="page">General Concepts</a>
  <ul>
    <li><a href="../general/terminology.html" class="page">Terminology, Concepts</a></li>
    <li><a href="../general/actor-systems.html" class="page">Actor Systems</a></li>
    <li><a href="../general/actors.html" class="page">What is an Actor?</a></li>
    <li><a href="../general/supervision.html#supervision-and-monitoring" class="active page">Supervision and Monitoring</a>
    <ul>
      <li><a href="../general/supervision.html#sample-project" class="header">Sample project</a></li>
      <li><a href="../general/supervision.html#what-supervision-means" class="header">What Supervision Means</a></li>
      <li><a href="../general/supervision.html#the-top-level-supervisors" class="header">The Top-Level Supervisors</a></li>
      <li><a href="../general/supervision.html#what-restarting-means" class="header">What Restarting Means</a></li>
      <li><a href="../general/supervision.html#what-lifecycle-monitoring-means" class="header">What Lifecycle Monitoring Means</a></li>
      <li><a href="../general/supervision.html#one-for-one-strategy-vs-all-for-one-strategy" class="header">One-For-One Strategy vs. All-For-One Strategy</a></li>
    </ul></li>
    <li><a href="../general/addressing.html" class="page">Actor References, Paths and Addresses</a></li>
    <li><a href="../general/remoting.html" class="page">Location Transparency</a></li>
    <li><a href="../general/jmm.html" class="page">Akka and the Java Memory Model</a></li>
    <li><a href="../general/message-delivery-reliability.html" class="page">Message Delivery Reliability</a></li>
    <li><a href="../general/configuration.html" class="page">Configuration</a></li>
  </ul></li>
  <li><a href="../index-actors.html" class="page">Actors</a></li>
  <li><a href="../typed/index.html" class="page">Akka Typed</a></li>
  <li><a href="../index-cluster.html" class="page">Clustering</a></li>
  <li><a href="../stream/index.html" class="page">Streams</a></li>
  <li><a href="../index-network.html" class="page">Networking</a></li>
  <li><a href="../discovery/index.html" class="page">Discovery</a></li>
  <li><a href="../index-futures.html" class="page">Futures and Agents</a></li>
  <li><a href="../index-utilities.html" class="page">Utilities</a></li>
  <li><a href="../common/other-modules.html" class="page">Other Akka modules</a></li>
  <li><a href="../howto.html" class="page">HowTo: Common Patterns</a></li>
  <li><a href="../project/index.html" class="page">Project Information</a></li>
  <li><a href="../additional/index.html" class="page">Additional Information</a></li>
  <li><a href="../chinese/index.html" class="page">中文版文档说明</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer fixed-sidebar-footer">
<a href="http://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"></a>

</footer>
</aside>

<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">

<article class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#supervision-and-monitoring" name="supervision-and-monitoring" class="anchor"><span class="anchor-link"></span></a>Supervision and Monitoring</h1>
<p>This chapter outlines the concept behind supervision, the primitives offered and their semantics. For details on how that translates into real code, please refer to the corresponding chapters for Scala and Java APIs.</p>
<h2><a href="#sample-project" name="sample-project" class="anchor"><span class="anchor-link"></span></a>Sample project</h2>
<p>You can look at the <a href="https://developer.lightbend.com/start/?group=akka&project=akka-samples-supervision-java">Supervision example project</a> to see what this looks like in practice.</p>
<a id="supervision-directives"></a>
<h2><a href="#what-supervision-means" name="what-supervision-means" class="anchor"><span class="anchor-link"></span></a>What Supervision Means</h2>
<p>As described in <a href="actor-systems.html">Actor Systems</a> supervision describes a dependency relationship between actors: the supervisor delegates tasks to subordinates and therefore must respond to their failures. When a subordinate detects a failure (i.e. throws an exception), it suspends itself and all its subordinates and sends a message to its supervisor, signaling failure. Depending on the nature of the work to be supervised and the nature of the failure, the supervisor has a choice of the following four options:</p>
<ol>
  <li>Resume the subordinate, keeping its accumulated internal state</li>
  <li>Restart the subordinate, clearing out its accumulated internal state</li>
  <li>Stop the subordinate permanently</li>
  <li>Escalate the failure, thereby failing itself</li>
</ol>
<p>It is important to always view an actor as part of a supervision hierarchy, which explains the existence of the fourth choice (as a supervisor also is subordinate to another supervisor higher up) and has implications on the first three: resuming an actor resumes all its subordinates, restarting an actor entails restarting all its subordinates (but see below for more details), similarly terminating an actor will also terminate all its subordinates. It should be noted that the default behavior of the <code>preRestart</code> hook of the <code>Actor</code> class is to terminate all its children before restarting, but this hook can be overridden; the recursive restart applies to all children left after this hook has been executed.</p>
<p>Each supervisor is configured with a function translating all possible failure causes (i.e. exceptions) into one of the four choices given above; notably, this function does not take the failed actor’s identity as an input. It is quite easy to come up with examples of structures where this might not seem flexible enough, e.g. wishing for different strategies to be applied to different subordinates. At this point it is vital to understand that supervision is about forming a recursive fault handling structure. If you try to do too much at one level, it will become hard to reason about, hence the recommended way in this case is to add a level of supervision.</p>
<p>Akka implements a specific form called “parental supervision”. Actors can only be created by other actors—where the top-level actor is provided by the library—and each created actor is supervised by its parent. This restriction makes the formation of actor supervision hierarchies implicit and encourages sound design decisions. It should be noted that this also guarantees that actors cannot be orphaned or attached to supervisors from the outside, which might otherwise catch them unawares. In addition, this yields a natural and clean shutdown procedure for (sub-trees of) actor applications.</p><div class="callout warning "><div class="callout-title">Warning</div>
<p>Supervision related parent-child communication happens by special system messages that have their own mailboxes separate from user messages. This implies that supervision related events are not deterministically ordered relative to ordinary messages. In general, the user cannot influence the order of normal messages and failure notifications. For details and example see the <a href="message-delivery-reliability.html#message-ordering">Discussion: Message Ordering</a> section.</p></div>
<a id="toplevel-supervisors"></a>
<h2><a href="#the-top-level-supervisors" name="the-top-level-supervisors" class="anchor"><span class="anchor-link"></span></a>The Top-Level Supervisors</h2>
<p><img src="guardians.png" alt="guardians.png" /></p>
<p>An actor system will during its creation start at least three actors, shown in the image above. For more information about the consequences for actor paths see <a href="addressing.html#toplevel-paths">Top-Level Scopes for Actor Paths</a>.</p>
<a id="user-guardian"></a>
<h3><a href="#user-the-guardian-actor" name="user-the-guardian-actor" class="anchor"><span class="anchor-link"></span></a><code>/user</code>: The Guardian Actor</h3>
<p>The actor which is probably most interacted with is the parent of all user-created actors, the guardian named <code>&quot;/user&quot;</code>. Actors created using <code>system.actorOf()</code> are children of this actor. This means that when this guardian terminates, all normal actors in the system will be shutdown, too. It also means that this guardian’s supervisor strategy determines how the top-level normal actors are supervised. Since Akka 2.1 it is possible to configure this using the setting <code>akka.actor.guardian-supervisor-strategy</code>, which takes the fully-qualified class-name of a <code>SupervisorStrategyConfigurator</code>. When the guardian escalates a failure, the root guardian’s response will be to terminate the guardian, which in effect will shut down the whole actor system.</p>
<h3><a href="#system-the-system-guardian" name="system-the-system-guardian" class="anchor"><span class="anchor-link"></span></a><code>/system</code>: The System Guardian</h3>
<p>This special guardian has been introduced in order to achieve an orderly shut-down sequence where logging remains active while all normal actors terminate, even though logging itself is implemented using actors. This is realized by having the system guardian watch the user guardian and initiate its own shut-down upon reception of the <code>Terminated</code> message. The top-level system actors are supervised using a strategy which will restart indefinitely upon all types of <code>Exception</code> except for <code>ActorInitializationException</code> and <code>ActorKilledException</code>, which will terminate the child in question. All other throwables are escalated, which will shut down the whole actor system.</p>
<h3><a href="#the-root-guardian" name="the-root-guardian" class="anchor"><span class="anchor-link"></span></a><code>/</code>: The Root Guardian</h3>
<p>The root guardian is the grand-parent of all so-called “top-level” actors and supervises all the special actors mentioned in <a href="addressing.html#toplevel-paths">Top-Level Scopes for Actor Paths</a> using the <code>SupervisorStrategy.stoppingStrategy</code>, whose purpose is to terminate the child upon any type of <code>Exception</code>. All other throwables will be escalated … but to whom? Since every real actor has a supervisor, the supervisor of the root guardian cannot be a real actor. And because this means that it is “outside of the bubble”, it is called the “bubble-walker”. This is a synthetic <code>ActorRef</code> which in effect stops its child upon the first sign of trouble and sets the actor system’s <code>isTerminated</code> status to <code>true</code> as soon as the root guardian is fully terminated (all children recursively stopped).</p>
<a id="supervision-restart"></a>
<h2><a href="#what-restarting-means" name="what-restarting-means" class="anchor"><span class="anchor-link"></span></a>What Restarting Means</h2>
<p>When presented with an actor which failed while processing a certain message, causes for the failure fall into three categories:</p>
<ul>
  <li>Systematic (i.e. programming) error for the specific message received</li>
  <li>(Transient) failure of some external resource used during processing the message</li>
  <li>Corrupt internal state of the actor</li>
</ul>
<p>Unless the failure is specifically recognizable, the third cause cannot be ruled out, which leads to the conclusion that the internal state needs to be cleared out. If the supervisor decides that its other children or itself is not affected by the corruption—e.g. because of conscious application of the error kernel pattern—it is therefore best to restart the child. This is carried out by creating a new instance of the underlying <code>Actor</code> class and replacing the failed instance with the fresh one inside the child’s <code>ActorRef</code>; the ability to do this is one of the reasons for encapsulating actors within special references. The new actor then resumes processing its mailbox, meaning that the restart is not visible outside of the actor itself with the notable exception that the message during which the failure occurred is not re-processed.</p>
<p>The precise sequence of events during a restart is the following:</p>
<ol>
  <li>suspend the actor (which means that it will not process normal messages until resumed), and recursively suspend all children</li>
  <li>call the old instance’s <code>preRestart</code> hook (defaults to sending termination requests to all children and calling <code>postStop</code>)</li>
  <li>wait for all children which were requested to terminate (using <code>context.stop()</code>) during <code>preRestart</code> to actually terminate; this—like all actor operations—is non-blocking, the termination notice from the last killed child will effect the progression to the next step</li>
  <li>create new actor instance by invoking the originally provided factory again</li>
  <li>invoke <code>postRestart</code> on the new instance (which by default also calls <code>preStart</code>)</li>
  <li>send restart request to all children which were not killed in step 3; restarted children will follow the same process recursively, from step 2</li>
  <li>resume the actor</li>
</ol>
<h2><a href="#what-lifecycle-monitoring-means" name="what-lifecycle-monitoring-means" class="anchor"><span class="anchor-link"></span></a>What Lifecycle Monitoring Means</h2><div class="callout note "><div class="callout-title">Note</div>
<p>Lifecycle Monitoring in Akka is usually referred to as <code>DeathWatch</code></p></div>
<p>In contrast to the special relationship between parent and child described above, each actor may monitor any other actor. Since actors emerge from creation fully alive and restarts are not visible outside of the affected supervisors, the only state change available for monitoring is the transition from alive to dead. Monitoring is thus used to tie one actor to another so that it may react to the other actor’s termination, in contrast to supervision which reacts to failure.</p>
<p>Lifecycle monitoring is implemented using a <code>Terminated</code> message to be received by the monitoring actor, where the default behavior is to throw a special <code>DeathPactException</code> if not otherwise handled. In order to start listening for <code>Terminated</code> messages, invoke <code>ActorContext.watch(targetActorRef)</code>. To stop listening, invoke <code>ActorContext.unwatch(targetActorRef)</code>. One important property is that the message will be delivered irrespective of the order in which the monitoring request and target’s termination occur, i.e. you still get the message even if at the time of registration the target is already dead.</p>
<p>Monitoring is particularly useful if a supervisor cannot restart its children and has to terminate them, e.g. in case of errors during actor initialization. In that case it should monitor those children and re-create them or schedule itself to retry this at a later time.</p>
<p>Another common use case is that an actor needs to fail in the absence of an external resource, which may also be one of its own children. If a third party terminates a child by way of the <code>system.stop(child)</code> method or sending a <code>PoisonPill</code>, the supervisor might well be affected.</p>
<a id="backoff-supervisor"></a>
<h3><a href="#delayed-restarts-with-the-backoffsupervisor-pattern" name="delayed-restarts-with-the-backoffsupervisor-pattern" class="anchor"><span class="anchor-link"></span></a>Delayed restarts with the BackoffSupervisor pattern</h3>
<p>Provided as a built-in pattern the <code>akka.pattern.BackoffSupervisor</code> implements the so-called <em>exponential backoff supervision strategy</em>, starting a child actor again when it fails, each time with a growing time delay between restarts.</p>
<p>This pattern is useful when the started actor fails <a id="^1" href="#1">[1]</a> because some external resource is not available, and we need to give it some time to start-up again. One of the prime examples when this is useful is when a <a href="../persistence.html">PersistentActor</a> fails (by stopping) with a persistence failure - which indicates that the database may be down or overloaded, in such situations it makes most sense to give it a little bit of time to recover before the persistent actor is started.</p>
<blockquote>
  <p><a id="1" href="#^1">[1]</a> A failure can be indicated in two different ways; by an actor stopping or crashing.</p>
</blockquote>
<p>The following Scala snippet shows how to create a backoff supervisor which will start the given echo actor after it has stopped because of a failure, in increasing intervals of 3, 6, 12, 24 and finally 30 seconds:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/xmeng1/akka/tree/master/akka-docs/src/test/scala/docs/pattern/BackoffSupervisorDocSpec.scala#L18-L30" target="_blank" title="Go to snippet source"></a><code class="language-scala">val childProps = Props(classOf[EchoActor])

val supervisor = BackoffSupervisor.props(
  Backoff.onStop(
    childProps,
    childName = &quot;myEcho&quot;,
    minBackoff = 3.seconds,
    maxBackoff = 30.seconds,
    randomFactor = 0.2, // adds 20% &quot;noise&quot; to vary the intervals slightly
    maxNrOfRetries = -1
  ))

system.actorOf(supervisor, name = &quot;echoSupervisor&quot;)</code></pre>
<p>The above is equivalent to this Java code:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/xmeng1/akka/tree/master/akka-docs/src/test/java/jdocs/pattern/BackoffSupervisorDocTest.java#L12" target="_blank" title="Go to snippet source"></a><code class="language-java">import java.time.Duration;</code></pre>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/xmeng1/akka/tree/master/akka-docs/src/test/java/jdocs/pattern/BackoffSupervisorDocTest.java#L19-L30" target="_blank" title="Go to snippet source"></a><code class="language-java">final Props childProps = Props.create(EchoActor.class);

final Props supervisorProps =
    BackoffSupervisor.props(
        Backoff.onStop(
            childProps,
            &quot;myEcho&quot;,
            Duration.ofSeconds(3),
            Duration.ofSeconds(30),
            0.2)); // adds 20% &quot;noise&quot; to vary the intervals slightly

system.actorOf(supervisorProps, &quot;echoSupervisor&quot;);</code></pre>
<p>Using a <code>randomFactor</code> to add a little bit of additional variance to the backoff intervals is highly recommended, in order to avoid multiple actors re-start at the exact same point in time, for example because they were stopped due to a shared resource such as a database going down and re-starting after the same configured interval. By adding additional randomness to the re-start intervals the actors will start in slightly different points in time, thus avoiding large spikes of traffic hitting the recovering shared database or other resource that they all need to contact.</p>
<p>The <code>akka.pattern.BackoffSupervisor</code> actor can also be configured to restart the actor after a delay when the actor crashes and the supervision strategy decides that it should restart.</p>
<p>The following Scala snippet shows how to create a backoff supervisor which will start the given echo actor after it has crashed because of some exception, in increasing intervals of 3, 6, 12, 24 and finally 30 seconds:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/xmeng1/akka/tree/master/akka-docs/src/test/scala/docs/pattern/BackoffSupervisorDocSpec.scala#L39-L51" target="_blank" title="Go to snippet source"></a><code class="language-scala">val childProps = Props(classOf[EchoActor])

val supervisor = BackoffSupervisor.props(
  Backoff.onFailure(
    childProps,
    childName = &quot;myEcho&quot;,
    minBackoff = 3.seconds,
    maxBackoff = 30.seconds,
    randomFactor = 0.2, // adds 20% &quot;noise&quot; to vary the intervals slightly
    maxNrOfRetries = -1
  ))

system.actorOf(supervisor, name = &quot;echoSupervisor&quot;)</code></pre>
<p>The above is equivalent to this Java code:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/xmeng1/akka/tree/master/akka-docs/src/test/java/jdocs/pattern/BackoffSupervisorDocTest.java#L12" target="_blank" title="Go to snippet source"></a><code class="language-java">import java.time.Duration;</code></pre>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/xmeng1/akka/tree/master/akka-docs/src/test/java/jdocs/pattern/BackoffSupervisorDocTest.java#L36-L47" target="_blank" title="Go to snippet source"></a><code class="language-java">final Props childProps = Props.create(EchoActor.class);

final Props supervisorProps =
    BackoffSupervisor.props(
        Backoff.onFailure(
            childProps,
            &quot;myEcho&quot;,
            Duration.ofSeconds(3),
            Duration.ofSeconds(30),
            0.2)); // adds 20% &quot;noise&quot; to vary the intervals slightly

system.actorOf(supervisorProps, &quot;echoSupervisor&quot;);</code></pre>
<p>The <code>akka.pattern.BackoffOptions</code> can be used to customize the behavior of the back-off supervisor actor, below are some examples:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/xmeng1/akka/tree/master/akka-docs/src/test/scala/docs/pattern/BackoffSupervisorDocSpec.scala#L62-L72" target="_blank" title="Go to snippet source"></a><code class="language-scala">val supervisor = BackoffSupervisor.props(
  Backoff.onStop(
    childProps,
    childName = &quot;myEcho&quot;,
    minBackoff = 3.seconds,
    maxBackoff = 30.seconds,
    randomFactor = 0.2, // adds 20% &quot;noise&quot; to vary the intervals slightly
    maxNrOfRetries = -1
  ).withManualReset // the child must send BackoffSupervisor.Reset to its parent
    .withDefaultStoppingStrategy // Stop at any Exception thrown
)</code></pre>
<p>The above code sets up a back-off supervisor that requires the child actor to send a <code>akka.pattern.BackoffSupervisor.Reset</code> message to its parent when a message is successfully processed, resetting the back-off. It also uses a default stopping strategy, any exception will cause the child to stop.</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/xmeng1/akka/tree/master/akka-docs/src/test/scala/docs/pattern/BackoffSupervisorDocSpec.scala#L85-L98" target="_blank" title="Go to snippet source"></a><code class="language-scala">val supervisor = BackoffSupervisor.props(
  Backoff.onFailure(
    childProps,
    childName = &quot;myEcho&quot;,
    minBackoff = 3.seconds,
    maxBackoff = 30.seconds,
    randomFactor = 0.2, // adds 20% &quot;noise&quot; to vary the intervals slightly
    maxNrOfRetries = -1
  ).withAutoReset(10.seconds) // reset if the child does not throw any errors within 10 seconds
    .withSupervisorStrategy(
      OneForOneStrategy() {
        case _: MyException ⇒ SupervisorStrategy.Restart
        case _              ⇒ SupervisorStrategy.Escalate
      }))</code></pre>
<p>The above code sets up a back-off supervisor that restarts the child after back-off if MyException is thrown, any other exception will be escalated. The back-off is automatically reset if the child does not throw any errors within 10 seconds.</p>
<h2><a href="#one-for-one-strategy-vs-all-for-one-strategy" name="one-for-one-strategy-vs-all-for-one-strategy" class="anchor"><span class="anchor-link"></span></a>One-For-One Strategy vs. All-For-One Strategy</h2>
<p>There are two classes of supervision strategies which come with Akka: <code>OneForOneStrategy</code> and <code>AllForOneStrategy</code>. Both are configured with a mapping from exception type to supervision directive (see <a href="#supervision-directives">above</a>) and limits on how often a child is allowed to fail before terminating it. The difference between them is that the former applies the obtained directive only to the failed child, whereas the latter applies it to all siblings as well. Normally, you should use the <code>OneForOneStrategy</code>, which also is the default if none is specified explicitly.</p>
<p>The <code>AllForOneStrategy</code> is applicable in cases where the ensemble of children has such tight dependencies among them, that a failure of one child affects the function of the others, i.e. they are inextricably linked. Since a restart does not clear out the mailbox, it often is best to terminate the children upon failure and re-create them explicitly from the supervisor (by watching the children’s lifecycle); otherwise you have to make sure that it is no problem for any of the actors to receive a message which was queued before the restart but processed afterwards.</p>
<p>Normally stopping a child (i.e. not in response to a failure) will not automatically terminate the other children in an all-for-one strategy; this can be done by watching their lifecycle: if the <code>Terminated</code> message is not handled by the supervisor, it will throw a <code>DeathPactException</code> which (depending on its supervisor) will restart it, and the default <code>preRestart</code> action will terminate all children. Of course this can be handled explicitly as well.</p>
<p>Please note that creating one-off actors from an all-for-one supervisor entails that failures escalated by the temporary actor will affect all the permanent ones. If this is not desired, install an intermediate supervisor; this can very be done by declaring a router of size 1 for the worker, see <a href="../routing.html">Routing</a>.</p>
</div>
</article>

<div class="row">
<div class="small-12 large-9 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../general/actors.html"><i class="icon-prev"></i> <span class="link-prev">What is an Actor?</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../general/addressing.html">Actor References, Paths and Addresses <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>

<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/xmeng1/akka/tree/master/akka-docs-cn/src/main/paradox/general/supervision.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>


<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg">
<section class="copyright">
<div>Akka is Open Source and available under the Apache 2 License.</div>
<p class="legal">
&copy; 2011-2019 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> | 
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> | 
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> | 
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> | 
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> | 
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>
</footer>

</section>
</main>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>

<!-- Algolia docs search -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<style>.algolia-autocomplete { display: block !important }</style>
<script type="text/javascript">
docsearch({
apiKey: '543bad5ad786495d9ccd445ed34ed082',
indexName: 'akka_io',
inputSelector: '#search',
algoliaOptions: {
hitsPerPage: 5
}
});

docsearch({
apiKey: '543bad5ad786495d9ccd445ed34ed082',
indexName: 'akka_io',
inputSelector: '#overlay-search',
algoliaOptions: {
hitsPerPage: 5
}
});

// set up "/" as global shortcut for focusing on search
jQuery(document).keypress(function (event) {
if (event.keyCode == 47) {
jQuery("#search").focus();
return false; // swallow key event, otherwise the / char would be input into the search box
}
});
</script>

<script type="text/javascript" src="../assets/js/warnOldDocs.js"></script>
<script type="text/javascript" src="../assets/js/scalafiddle.js"></script>


</body>
</html>
